import sys
import subprocess
import re
from bs4 import BeautifulSoup
import requests

def main():
    serviceList = sys.argv[1:]
    for service in serviceList:
        liste = getExploits(service, 0)
        getDetails(liste)
    return "ok"

def clean_ansi(text: str) -> str:
    ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
    return ansi_escape.sub('', text)


def getExploits(service: str, version: str = None):
    command = buildCommand(service, version)
    result = subprocess.run(command, shell=True, capture_output=True, text=True)
    if result.returncode == 0:
        lines = result.stdout.split("\n")
        liste = list()
        for line in lines[3:]:
            if '|' in line:
                clean_line = clean_ansi(line)
                title, path = clean_line.split("|")
                exploit = {
                    "title": title,
                    "link": path
                }
                liste.append(exploit)
        return liste
    else:
        print(result.stderr)
    return liste


def getDetails(liste_object: list):
    print(liste_object[10])
    for item in liste_object:
        page = getPage(item["link"])
        soup = BeautifulSoup(page, "html.parser")
        print(soup.prettify())



def getPage(url: str):
    response = requests.get(url)
    return response.text


def buildCommand(service: str, version: str):
    return f"searchsploit {service} {version} -w" if version != 0 else f"searchsploit {service} -w"
    
if __name__ == "__main__":
    main()